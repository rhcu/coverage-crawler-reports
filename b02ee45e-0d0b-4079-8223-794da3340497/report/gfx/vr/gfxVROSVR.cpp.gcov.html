<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - gfx/vr/gfxVROSVR.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">gfx/vr</a> - gfxVROSVR.cpp<span style="font-size: 80%;"> (source / <a href="gfxVROSVR.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntry">216</td>
            <td class="headerCovTableEntryLo">1.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2018-08-07 16:42:27</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntryHi">-</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=8 sts=2 et sw=2 tw=80: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &lt;math.h&gt;
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;prenv.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;gfxPrefs.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsString.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;mozilla/Preferences.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;mozilla/SharedLibrary.h&quot;
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #include &quot;mozilla/gfx/Quaternion.h&quot;
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : #ifdef XP_WIN
<span class="lineNum">      18 </span>            : #include &quot;../layers/d3d11/CompositorD3D11.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;../layers/d3d11/TextureD3D11.h&quot;
<span class="lineNum">      20 </span>            : #endif
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : #include &quot;gfxVROSVR.h&quot;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &quot;mozilla/dom/GamepadEventTypes.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;mozilla/dom/GamepadBinding.h&quot;
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : #ifndef M_PI
<span class="lineNum">      28 </span>            : #define M_PI 3.14159265358979323846
<span class="lineNum">      29 </span>            : #endif
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : using namespace mozilla::layers;
<span class="lineNum">      32 </span>            : using namespace mozilla::gfx;
<span class="lineNum">      33 </span>            : using namespace mozilla::gfx::impl;
<span class="lineNum">      34 </span>            : using namespace mozilla::dom;
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : namespace {
<span class="lineNum">      37 </span>            : // need to typedef functions that will be used in the code below
<span class="lineNum">      38 </span>            : extern &quot;C&quot; {
<span class="lineNum">      39 </span>            : typedef OSVR_ClientContext (*pfn_osvrClientInit)(
<span class="lineNum">      40 </span>            :   const char applicationIdentifier[], uint32_t flags);
<span class="lineNum">      41 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientShutdown)(OSVR_ClientContext ctx);
<span class="lineNum">      42 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientUpdate)(OSVR_ClientContext ctx);
<span class="lineNum">      43 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientCheckStatus)(OSVR_ClientContext ctx);
<span class="lineNum">      44 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientGetInterface)(
<span class="lineNum">      45 </span>            :   OSVR_ClientContext ctx, const char path[], OSVR_ClientInterface* iface);
<span class="lineNum">      46 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientFreeInterface)(
<span class="lineNum">      47 </span>            :   OSVR_ClientContext ctx, OSVR_ClientInterface iface);
<span class="lineNum">      48 </span>            : typedef OSVR_ReturnCode (*pfn_osvrGetOrientationState)(
<span class="lineNum">      49 </span>            :   OSVR_ClientInterface iface, OSVR_TimeValue* timestamp,
<span class="lineNum">      50 </span>            :   OSVR_OrientationState* state);
<span class="lineNum">      51 </span>            : typedef OSVR_ReturnCode (*pfn_osvrGetPositionState)(OSVR_ClientInterface iface,
<span class="lineNum">      52 </span>            :                                                     OSVR_TimeValue* timestamp,
<span class="lineNum">      53 </span>            :                                                     OSVR_PositionState* state);
<span class="lineNum">      54 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientGetDisplay)(OSVR_ClientContext ctx,
<span class="lineNum">      55 </span>            :                                                     OSVR_DisplayConfig* disp);
<span class="lineNum">      56 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientFreeDisplay)(OSVR_DisplayConfig disp);
<span class="lineNum">      57 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientGetNumEyesForViewer)(
<span class="lineNum">      58 </span>            :   OSVR_DisplayConfig disp, OSVR_ViewerCount viewer, OSVR_EyeCount* eyes);
<span class="lineNum">      59 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientGetViewerEyePose)(
<span class="lineNum">      60 </span>            :   OSVR_DisplayConfig disp, OSVR_ViewerCount viewer, OSVR_EyeCount eye,
<span class="lineNum">      61 </span>            :   OSVR_Pose3* pose);
<span class="lineNum">      62 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientGetDisplayDimensions)(
<span class="lineNum">      63 </span>            :   OSVR_DisplayConfig disp, OSVR_DisplayInputCount displayInputIndex,
<span class="lineNum">      64 </span>            :   OSVR_DisplayDimension* width, OSVR_DisplayDimension* height);
<span class="lineNum">      65 </span>            : typedef OSVR_ReturnCode (
<span class="lineNum">      66 </span>            :   *pfn_osvrClientGetViewerEyeSurfaceProjectionClippingPlanes)(
<span class="lineNum">      67 </span>            :   OSVR_DisplayConfig disp, OSVR_ViewerCount viewer, OSVR_EyeCount eye,
<span class="lineNum">      68 </span>            :   OSVR_SurfaceCount surface, double* left, double* right, double* bottom,
<span class="lineNum">      69 </span>            :   double* top);
<span class="lineNum">      70 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientGetRelativeViewportForViewerEyeSurface)(
<span class="lineNum">      71 </span>            :   OSVR_DisplayConfig disp, OSVR_ViewerCount viewer, OSVR_EyeCount eye,
<span class="lineNum">      72 </span>            :   OSVR_SurfaceCount surface, OSVR_ViewportDimension* left,
<span class="lineNum">      73 </span>            :   OSVR_ViewportDimension* bottom, OSVR_ViewportDimension* width,
<span class="lineNum">      74 </span>            :   OSVR_ViewportDimension* height);
<span class="lineNum">      75 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientGetViewerEyeSurfaceProjectionMatrixf)(
<span class="lineNum">      76 </span>            :   OSVR_DisplayConfig disp, OSVR_ViewerCount viewer, OSVR_EyeCount eye,
<span class="lineNum">      77 </span>            :   OSVR_SurfaceCount surface, float near, float far,
<span class="lineNum">      78 </span>            :   OSVR_MatrixConventions flags, float* matrix);
<span class="lineNum">      79 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientCheckDisplayStartup)(
<span class="lineNum">      80 </span>            :   OSVR_DisplayConfig disp);
<span class="lineNum">      81 </span>            : typedef OSVR_ReturnCode (*pfn_osvrClientSetRoomRotationUsingHead)(
<span class="lineNum">      82 </span>            :   OSVR_ClientContext ctx);
<span class="lineNum">      83 </span>            : }
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span>            : static pfn_osvrClientInit osvr_ClientInit = nullptr;
<span class="lineNum">      86 </span>            : static pfn_osvrClientShutdown osvr_ClientShutdown = nullptr;
<span class="lineNum">      87 </span>            : static pfn_osvrClientUpdate osvr_ClientUpdate = nullptr;
<span class="lineNum">      88 </span>            : static pfn_osvrClientCheckStatus osvr_ClientCheckStatus = nullptr;
<span class="lineNum">      89 </span>            : static pfn_osvrClientGetInterface osvr_ClientGetInterface = nullptr;
<span class="lineNum">      90 </span>            : static pfn_osvrClientFreeInterface osvr_ClientFreeInterface = nullptr;
<span class="lineNum">      91 </span>            : static pfn_osvrGetOrientationState osvr_GetOrientationState = nullptr;
<span class="lineNum">      92 </span>            : static pfn_osvrGetPositionState osvr_GetPositionState = nullptr;
<span class="lineNum">      93 </span>            : static pfn_osvrClientGetDisplay osvr_ClientGetDisplay = nullptr;
<span class="lineNum">      94 </span>            : static pfn_osvrClientFreeDisplay osvr_ClientFreeDisplay = nullptr;
<span class="lineNum">      95 </span>            : static pfn_osvrClientGetNumEyesForViewer osvr_ClientGetNumEyesForViewer =
<span class="lineNum">      96 </span>            :   nullptr;
<span class="lineNum">      97 </span>            : static pfn_osvrClientGetViewerEyePose osvr_ClientGetViewerEyePose = nullptr;
<span class="lineNum">      98 </span>            : static pfn_osvrClientGetDisplayDimensions osvr_ClientGetDisplayDimensions =
<span class="lineNum">      99 </span>            :   nullptr;
<span class="lineNum">     100 </span>            : static pfn_osvrClientGetViewerEyeSurfaceProjectionClippingPlanes
<span class="lineNum">     101 </span>            :   osvr_ClientGetViewerEyeSurfaceProjectionClippingPlanes = nullptr;
<span class="lineNum">     102 </span>            : static pfn_osvrClientGetRelativeViewportForViewerEyeSurface
<span class="lineNum">     103 </span>            :   osvr_ClientGetRelativeViewportForViewerEyeSurface = nullptr;
<span class="lineNum">     104 </span>            : static pfn_osvrClientGetViewerEyeSurfaceProjectionMatrixf
<span class="lineNum">     105 </span>            :   osvr_ClientGetViewerEyeSurfaceProjectionMatrixf = nullptr;
<span class="lineNum">     106 </span>            : static pfn_osvrClientCheckDisplayStartup osvr_ClientCheckDisplayStartup =
<span class="lineNum">     107 </span>            :   nullptr;
<span class="lineNum">     108 </span>            : static pfn_osvrClientSetRoomRotationUsingHead
<span class="lineNum">     109 </span>            :   osvr_ClientSetRoomRotationUsingHead = nullptr;
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span>            : bool
<span class="lineNum">     112 </span><span class="lineNoCov">          0 : LoadOSVRRuntime()</span>
<span class="lineNum">     113 </span>            : {
<span class="lineNum">     114 </span>            :   static PRLibrary* osvrUtilLib = nullptr;
<span class="lineNum">     115 </span>            :   static PRLibrary* osvrCommonLib = nullptr;
<span class="lineNum">     116 </span>            :   static PRLibrary* osvrClientLib = nullptr;
<span class="lineNum">     117 </span>            :   static PRLibrary* osvrClientKitLib = nullptr;
<span class="lineNum">     118 </span>            :   //this looks up the path in the about:config setting, from greprefs.js or modules\libpref\init\all.js
<span class="lineNum">     119 </span>            :   //we need all the libs to be valid
<span class="lineNum">     120 </span>            : #ifdef XP_WIN
<span class="lineNum">     121 </span>            :   constexpr static auto* pfnGetPathStringPref = mozilla::Preferences::GetString;
<span class="lineNum">     122 </span>            :   nsAutoString osvrUtilPath, osvrCommonPath, osvrClientPath, osvrClientKitPath;
<span class="lineNum">     123 </span>            : #else
<span class="lineNum">     124 </span>            :   constexpr static auto* pfnGetPathStringPref = mozilla::Preferences::GetCString;
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :   nsAutoCString osvrUtilPath, osvrCommonPath, osvrClientPath, osvrClientKitPath;</span>
<span class="lineNum">     126 </span>            : #endif
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   if (NS_FAILED(pfnGetPathStringPref(&quot;gfx.vr.osvr.utilLibPath&quot;,</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :                                      osvrUtilPath, PrefValueKind::User)) ||</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :       NS_FAILED(pfnGetPathStringPref(&quot;gfx.vr.osvr.commonLibPath&quot;,</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :                                      osvrCommonPath, PrefValueKind::User)) ||</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :       NS_FAILED(pfnGetPathStringPref(&quot;gfx.vr.osvr.clientLibPath&quot;,</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :                                      osvrClientPath, PrefValueKind::User)) ||</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :       NS_FAILED(pfnGetPathStringPref(&quot;gfx.vr.osvr.clientKitLibPath&quot;,</span>
<span class="lineNum">     134 </span>            :                                      osvrClientKitPath, PrefValueKind::User))) {
<span class="lineNum">     135 </span>            :     return false;
<span class="lineNum">     136 </span>            :   }
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :   osvrUtilLib = LoadLibraryWithFlags(osvrUtilPath.get());</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :   osvrCommonLib = LoadLibraryWithFlags(osvrCommonPath.get());</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :   osvrClientLib = LoadLibraryWithFlags(osvrClientPath.get());</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   osvrClientKitLib = LoadLibraryWithFlags(osvrClientKitPath.get());</span>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :   if (!osvrUtilLib) {</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :     printf_stderr(&quot;[OSVR] Failed to load OSVR Util library!\n&quot;);</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     146 </span>            :   }
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :   if (!osvrCommonLib) {</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     printf_stderr(&quot;[OSVR] Failed to load OSVR Common library!\n&quot;);</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     150 </span>            :   }
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   if (!osvrClientLib) {</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :     printf_stderr(&quot;[OSVR] Failed to load OSVR Client library!\n&quot;);</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     154 </span>            :   }
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :   if (!osvrClientKitLib) {</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :     printf_stderr(&quot;[OSVR] Failed to load OSVR ClientKit library!\n&quot;);</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     158 </span>            :   }
<span class="lineNum">     159 </span>            : 
<span class="lineNum">     160 </span>            : // make sure all functions that we'll be using are available
<span class="lineNum">     161 </span>            : #define REQUIRE_FUNCTION(_x)                                                   \
<span class="lineNum">     162 </span>            :   do {                                                                         \
<span class="lineNum">     163 </span>            :     *(void**) &amp; osvr_##_x =                                                    \
<span class="lineNum">     164 </span>            :       (void*)PR_FindSymbol(osvrClientKitLib, &quot;osvr&quot; #_x);                      \
<span class="lineNum">     165 </span>            :     if (!osvr_##_x) {                                                          \
<span class="lineNum">     166 </span>            :       printf_stderr(&quot;osvr&quot; #_x &quot; symbol missing\n&quot;);                           \
<span class="lineNum">     167 </span>            :       goto fail;                                                               \
<span class="lineNum">     168 </span>            :     }                                                                          \
<span class="lineNum">     169 </span>            :   } while (0)
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientInit);</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientShutdown);</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientUpdate);</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientCheckStatus);</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientGetInterface);</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientFreeInterface);</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(GetOrientationState);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(GetPositionState);</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientGetDisplay);</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientFreeDisplay);</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientGetNumEyesForViewer);</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientGetViewerEyePose);</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientGetDisplayDimensions);</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientGetViewerEyeSurfaceProjectionClippingPlanes);</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientGetRelativeViewportForViewerEyeSurface);</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientGetViewerEyeSurfaceProjectionMatrixf);</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientCheckDisplayStartup);</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   REQUIRE_FUNCTION(ClientSetRoomRotationUsingHead);</span>
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span>            : #undef REQUIRE_FUNCTION
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span>            :   return true;
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            : fail:
<span class="lineNum">     195 </span>            :   return false;
<span class="lineNum">     196 </span>            : }
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span>            : } // namespace
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            : mozilla::gfx::VRFieldOfView
<span class="lineNum">     201 </span><span class="lineNoCov">          0 : SetFromTanRadians(double left, double right, double bottom, double top)</span>
<span class="lineNum">     202 </span>            : {
<span class="lineNum">     203 </span>            :   mozilla::gfx::VRFieldOfView fovInfo;
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :   fovInfo.leftDegrees = atan(left) * 180.0 / M_PI;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :   fovInfo.rightDegrees = atan(right) * 180.0 / M_PI;</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :   fovInfo.upDegrees = atan(top) * 180.0 / M_PI;</span>
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :   fovInfo.downDegrees = atan(bottom) * 180.0 / M_PI;</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :   return fovInfo;</span>
<span class="lineNum">     209 </span>            : }
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span><span class="lineNoCov">          0 : VRDisplayOSVR::VRDisplayOSVR(OSVR_ClientContext* context,</span>
<span class="lineNum">     212 </span>            :                          OSVR_ClientInterface* iface,
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                          OSVR_DisplayConfig* display)</span>
<span class="lineNum">     214 </span>            :   : VRDisplayHost(VRDeviceType::OSVR)
<span class="lineNum">     215 </span>            :   , m_ctx(context)
<span class="lineNum">     216 </span>            :   , m_iface(iface)
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :   , m_display(display)</span>
<span class="lineNum">     218 </span>            : {
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   MOZ_COUNT_CTOR_INHERITED(VRDisplayOSVR, VRDisplayHost);</span>
<span class="lineNum">     221 </span>            : 
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :   VRDisplayState&amp; state = mDisplayInfo.mDisplayState;</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :   state.mIsConnected = true;</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :   strncpy(state.mDisplayName, &quot;OSVR HMD&quot;, kVRDisplayNameMaxLen);</span>
<span class="lineNum">     225 </span>            :   state.mCapabilityFlags = VRDisplayCapabilityFlags::Cap_None;
<span class="lineNum">     226 </span>            :   state.mCapabilityFlags =
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :     VRDisplayCapabilityFlags::Cap_Orientation | VRDisplayCapabilityFlags::Cap_Position;</span>
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   state.mCapabilityFlags |= VRDisplayCapabilityFlags::Cap_External;</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :   state.mCapabilityFlags |= VRDisplayCapabilityFlags::Cap_Present;</span>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span>            :   // XXX OSVR display topology allows for more than one viewer
<span class="lineNum">     233 </span>            :   // will assume only one viewer for now (most likely stay that way)
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            :   OSVR_EyeCount numEyes;
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :   osvr_ClientGetNumEyesForViewer(*m_display, 0, &amp;numEyes);</span>
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :   for (uint8_t eye = 0; eye &lt; numEyes; eye++) {</span>
<span class="lineNum">     239 </span>            :     double left, right, bottom, top;
<span class="lineNum">     240 </span>            :     // XXX for now there is only one surface per eye
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     osvr_ClientGetViewerEyeSurfaceProjectionClippingPlanes(</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :       *m_display, 0, eye, 0, &amp;left, &amp;right, &amp;bottom, &amp;top);</span>
<span class="lineNum">     243 </span>            :     state.mEyeFOV[eye] =
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :       SetFromTanRadians(-left, right, -bottom, top);</span>
<span class="lineNum">     245 </span>            :   }
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span>            :   // XXX Assuming there is only one display input for now
<span class="lineNum">     248 </span>            :   // however, it's possible to have more than one (dSight with 2 HDMI inputs)
<span class="lineNum">     249 </span>            :   OSVR_DisplayDimension width, height;
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   osvr_ClientGetDisplayDimensions(*m_display, 0, &amp;width, &amp;height);</span>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span>            : 
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :   for (uint8_t eye = 0; eye &lt; numEyes; eye++) {</span>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span>            :     OSVR_ViewportDimension l, b, w, h;
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :     osvr_ClientGetRelativeViewportForViewerEyeSurface(*m_display, 0, eye, 0, &amp;l,</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :                                                       &amp;b, &amp;w, &amp;h);</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     state.mEyeResolution.width = w;</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :     state.mEyeResolution.height = h;</span>
<span class="lineNum">     260 </span>            :     OSVR_Pose3 eyePose;
<span class="lineNum">     261 </span>            :     // Viewer eye pose may not be immediately available, update client context until we get it
<span class="lineNum">     262 </span>            :     OSVR_ReturnCode ret =
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :       osvr_ClientGetViewerEyePose(*m_display, 0, eye, &amp;eyePose);</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     while (ret != OSVR_RETURN_SUCCESS) {</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :       osvr_ClientUpdate(*m_ctx);</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :       ret = osvr_ClientGetViewerEyePose(*m_display, 0, eye, &amp;eyePose);</span>
<span class="lineNum">     267 </span>            :     }
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     state.mEyeTranslation[eye].x = eyePose.translation.data[0];</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :     state.mEyeTranslation[eye].y = eyePose.translation.data[1];</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     state.mEyeTranslation[eye].z = eyePose.translation.data[2];</span>
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     Matrix4x4 pose;</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     pose.SetRotationFromQuaternion(gfx::Quaternion(osvrQuatGetX(&amp;eyePose.rotation),</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :                                                    osvrQuatGetY(&amp;eyePose.rotation),</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :                                                    osvrQuatGetZ(&amp;eyePose.rotation),</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :                                                    osvrQuatGetW(&amp;eyePose.rotation)));</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     pose.PreTranslate(eyePose.translation.data[0], eyePose.translation.data[1], eyePose.translation.data[2]);</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :     pose.Invert();</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     mHeadToEye[eye] = pose;</span>
<span class="lineNum">     280 </span>            :   }
<span class="lineNum">     281 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span>            : void
<span class="lineNum">     284 </span><span class="lineNoCov">          0 : VRDisplayOSVR::Destroy()</span>
<span class="lineNum">     285 </span>            : {
<span class="lineNum">     286 </span>            :   // destroy non-owning pointers
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :   m_ctx = nullptr;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   m_iface = nullptr;</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   m_display = nullptr;</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span>            : void
<span class="lineNum">     293 </span><span class="lineNoCov">          0 : VRDisplayOSVR::ZeroSensor()</span>
<span class="lineNum">     294 </span>            : {
<span class="lineNum">     295 </span>            :   // recenter pose aka reset yaw
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :   osvr_ClientSetRoomRotationUsingHead(*m_ctx);</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span>            : VRHMDSensorState
<span class="lineNum">     300 </span><span class="lineNoCov">          0 : VRDisplayOSVR::GetSensorState()</span>
<span class="lineNum">     301 </span>            : {
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span>            :   //update client context before anything
<span class="lineNum">     304 </span>            :   //this usually goes into app's mainloop
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   osvr_ClientUpdate(*m_ctx);</span>
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :   VRHMDSensorState result{};</span>
<span class="lineNum">     308 </span>            :   OSVR_TimeValue timestamp;
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span>            :   OSVR_OrientationState orientation;
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :   OSVR_ReturnCode ret =
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :     osvr_GetOrientationState(*m_iface, &amp;timestamp, &amp;orientation);</span>
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :   result.timestamp = timestamp.seconds;</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :   result.inputFrameID = mDisplayInfo.mFrameId;</span>
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :   if (ret == OSVR_RETURN_SUCCESS) {</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     result.flags |= VRDisplayCapabilityFlags::Cap_Orientation;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     result.orientation[0] = orientation.data[1];</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     result.orientation[1] = orientation.data[2];</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     result.orientation[2] = orientation.data[3];</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :     result.orientation[3] = orientation.data[0];</span>
<span class="lineNum">     324 </span>            :   } else {
<span class="lineNum">     325 </span>            :     // default to an identity quaternion
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :     result.orientation[3] = 1.0f;</span>
<span class="lineNum">     327 </span>            :   }
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            :   OSVR_PositionState position;
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :   ret = osvr_GetPositionState(*m_iface, &amp;timestamp, &amp;position);</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   if (ret == OSVR_RETURN_SUCCESS) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     result.flags |= VRDisplayCapabilityFlags::Cap_Position;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     result.position[0] = position.data[0];</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     result.position[1] = position.data[1];</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     result.position[2] = position.data[2];</span>
<span class="lineNum">     336 </span>            :   }
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :   result.CalcViewMatrices(mHeadToEye);</span>
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">     341 </span>            : }
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span>            : #if defined(XP_WIN)
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span>            : bool
<span class="lineNum">     346 </span>            : VRDisplayOSVR::SubmitFrame(ID3D11Texture2D* aSource,
<span class="lineNum">     347 </span>            :   const IntSize&amp; aSize,
<span class="lineNum">     348 </span>            :   const gfx::Rect&amp; aLeftEyeRect,
<span class="lineNum">     349 </span>            :   const gfx::Rect&amp; aRightEyeRect)
<span class="lineNum">     350 </span>            : {
<span class="lineNum">     351 </span>            :   // XXX Add code to submit frame
<span class="lineNum">     352 </span>            :   return false;
<span class="lineNum">     353 </span>            : }
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            : #elif defined(XP_MACOSX)
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span>            : bool
<span class="lineNum">     358 </span>            : VRDisplayOSVR::SubmitFrame(MacIOSurface* aMacIOSurface,
<span class="lineNum">     359 </span>            :                            const IntSize&amp; aSize,
<span class="lineNum">     360 </span>            :                            const gfx::Rect&amp; aLeftEyeRect,
<span class="lineNum">     361 </span>            :                            const gfx::Rect&amp; aRightEyeRect)
<span class="lineNum">     362 </span>            : {
<span class="lineNum">     363 </span>            :   // XXX Add code to submit frame
<span class="lineNum">     364 </span>            :   MOZ_ASSERT(mSubmitThread-&gt;GetThread() == NS_GetCurrentThread());
<span class="lineNum">     365 </span>            :   return false;
<span class="lineNum">     366 </span>            : }
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span>            : #endif
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span>            : void
<span class="lineNum">     371 </span><span class="lineNoCov">          0 : VRDisplayOSVR::StartPresentation()</span>
<span class="lineNum">     372 </span>            : {
<span class="lineNum">     373 </span>            :   // XXX Add code to start VR Presentation
<span class="lineNum">     374 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span>            : void
<span class="lineNum">     377 </span><span class="lineNoCov">          0 : VRDisplayOSVR::StopPresentation()</span>
<span class="lineNum">     378 </span>            : {
<span class="lineNum">     379 </span>            :   // XXX Add code to end VR Presentation
<span class="lineNum">     380 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            : already_AddRefed&lt;VRSystemManagerOSVR&gt;
<span class="lineNum">     383 </span><span class="lineCov">          1 : VRSystemManagerOSVR::Create()</span>
<span class="lineNum">     384 </span>            : {
<span class="lineNum">     385 </span><span class="lineCov">          1 :   MOZ_ASSERT(NS_IsMainThread());</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineCov">          1 :   if (!gfxPrefs::VREnabled() || !gfxPrefs::VROSVREnabled()) {</span>
<span class="lineNum">     388 </span>            :     return nullptr;
<span class="lineNum">     389 </span>            :   }
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :   if (!LoadOSVRRuntime()) {</span>
<span class="lineNum">     391 </span>            :     return nullptr;
<span class="lineNum">     392 </span>            :   }
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :   RefPtr&lt;VRSystemManagerOSVR&gt; manager = new VRSystemManagerOSVR();</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :   return manager.forget();</span>
<span class="lineNum">     395 </span>            : }
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span>            : void
<span class="lineNum">     398 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::CheckOSVRStatus()</span>
<span class="lineNum">     399 </span>            : {
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :   if (mOSVRInitialized) {</span>
<span class="lineNum">     401 </span>            :     return;
<span class="lineNum">     402 </span>            :   }
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span>            :   // client context must be initialized first
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :   InitializeClientContext();</span>
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span>            :   // update client context
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :   osvr_ClientUpdate(m_ctx);</span>
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span>            :   // initialize interface and display if they are not initialized yet
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :   InitializeInterface();</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   InitializeDisplay();</span>
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span>            :   // OSVR is fully initialized now
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :   if (mClientContextInitialized &amp;&amp; mDisplayConfigInitialized &amp;&amp;</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :       mInterfaceInitialized) {</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :     mOSVRInitialized = true;</span>
<span class="lineNum">     418 </span>            :   }
<span class="lineNum">     419 </span>            : }
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span>            : void
<span class="lineNum">     422 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::InitializeClientContext()</span>
<span class="lineNum">     423 </span>            : {
<span class="lineNum">     424 </span>            :   // already initialized
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :   if (mClientContextInitialized) {</span>
<span class="lineNum">     426 </span>            :     return;
<span class="lineNum">     427 </span>            :   }
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span>            :   // first time creating
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :   if (!m_ctx) {</span>
<span class="lineNum">     431 </span>            :     // get client context
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     m_ctx = osvr_ClientInit(&quot;com.osvr.webvr&quot;, 0);</span>
<span class="lineNum">     433 </span>            :     // update context
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :     osvr_ClientUpdate(m_ctx);</span>
<span class="lineNum">     435 </span>            :     // verify we are connected
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :     if (OSVR_RETURN_SUCCESS == osvr_ClientCheckStatus(m_ctx)) {</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :       mClientContextInitialized = true;</span>
<span class="lineNum">     438 </span>            :     }
<span class="lineNum">     439 </span>            :   }
<span class="lineNum">     440 </span>            :   // client context exists but not up and running yet
<span class="lineNum">     441 </span>            :   else {
<span class="lineNum">     442 </span>            :     // update context
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :     osvr_ClientUpdate(m_ctx);</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :     if (OSVR_RETURN_SUCCESS == osvr_ClientCheckStatus(m_ctx)) {</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :       mClientContextInitialized = true;</span>
<span class="lineNum">     446 </span>            :     }
<span class="lineNum">     447 </span>            :   }
<span class="lineNum">     448 </span>            : }
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span>            : void
<span class="lineNum">     451 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::InitializeInterface()</span>
<span class="lineNum">     452 </span>            : {
<span class="lineNum">     453 </span>            :   // already initialized
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   if (mInterfaceInitialized) {</span>
<span class="lineNum">     455 </span>            :     return;
<span class="lineNum">     456 </span>            :   }
<span class="lineNum">     457 </span>            :   //Client context must be initialized before getting interface
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   if (mClientContextInitialized) {</span>
<span class="lineNum">     459 </span>            :     // m_iface will remain nullptr if no interface is returned
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :     if (OSVR_RETURN_SUCCESS ==</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :         osvr_ClientGetInterface(m_ctx, &quot;/me/head&quot;, &amp;m_iface)) {</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :       mInterfaceInitialized = true;</span>
<span class="lineNum">     463 </span>            :     }
<span class="lineNum">     464 </span>            :   }
<span class="lineNum">     465 </span>            : }
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span>            : void
<span class="lineNum">     468 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::InitializeDisplay()</span>
<span class="lineNum">     469 </span>            : {
<span class="lineNum">     470 </span>            :   // display is fully configured
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :   if (mDisplayConfigInitialized) {</span>
<span class="lineNum">     472 </span>            :     return;
<span class="lineNum">     473 </span>            :   }
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span>            :   //Client context must be initialized before getting interface
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :   if (mClientContextInitialized) {</span>
<span class="lineNum">     477 </span>            :     // first time creating display object
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     if (m_display == nullptr) {</span>
<span class="lineNum">     479 </span>            : 
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :       OSVR_ReturnCode ret = osvr_ClientGetDisplay(m_ctx, &amp;m_display);</span>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :       if (ret == OSVR_RETURN_SUCCESS) {</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :         osvr_ClientUpdate(m_ctx);</span>
<span class="lineNum">     484 </span>            :         // display object may have been created but not fully startup
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :         if (OSVR_RETURN_SUCCESS == osvr_ClientCheckDisplayStartup(m_display)) {</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :           mDisplayConfigInitialized = true;</span>
<span class="lineNum">     487 </span>            :         }
<span class="lineNum">     488 </span>            :       }
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span>            :       // Typically once we get Display object, pose data is available after
<span class="lineNum">     491 </span>            :       // clientUpdate but sometimes it takes ~ 200 ms to get
<span class="lineNum">     492 </span>            :       // a succesfull connection, so we might have to run a few update cycles
<span class="lineNum">     493 </span>            :     } else {
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :       if (OSVR_RETURN_SUCCESS == osvr_ClientCheckDisplayStartup(m_display)) {</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :         mDisplayConfigInitialized = true;</span>
<span class="lineNum">     497 </span>            :       }
<span class="lineNum">     498 </span>            :     }
<span class="lineNum">     499 </span>            :   }
<span class="lineNum">     500 </span>            : }
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            : bool
<span class="lineNum">     503 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::Init()</span>
<span class="lineNum">     504 </span>            : {
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            :   // OSVR server should be running in the background
<span class="lineNum">     507 </span>            :   // It would load plugins and take care of detecting HMDs
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :   if (!mOSVRInitialized) {</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :     nsIThread* thread = nullptr;</span>
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :     NS_GetCurrentThread(&amp;thread);</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     mOSVRThread = already_AddRefed&lt;nsIThread&gt;(thread);</span>
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span>            :     // initialize client context
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :     InitializeClientContext();</span>
<span class="lineNum">     515 </span>            :     // try to initialize interface
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :     InitializeInterface();</span>
<span class="lineNum">     517 </span>            :     // try to initialize display object
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     InitializeDisplay();</span>
<span class="lineNum">     519 </span>            :     // verify all components are initialized
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :     CheckOSVRStatus();</span>
<span class="lineNum">     521 </span>            :   }
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :   return mOSVRInitialized;</span>
<span class="lineNum">     524 </span>            : }
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span>            : void
<span class="lineNum">     527 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::Destroy()</span>
<span class="lineNum">     528 </span>            : {
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :   Shutdown();</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span>            : void
<span class="lineNum">     533 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::Shutdown()</span>
<span class="lineNum">     534 </span>            : {
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :   if (mOSVRInitialized) {</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :     MOZ_ASSERT(NS_GetCurrentThread() == mOSVRThread);</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :     mOSVRThread = nullptr;</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :     mHMDInfo = nullptr;</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :     mOSVRInitialized = false;</span>
<span class="lineNum">     540 </span>            :   }
<span class="lineNum">     541 </span>            :   // client context may not have been initialized
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :   if (m_ctx) {</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :     osvr_ClientFreeDisplay(m_display);</span>
<span class="lineNum">     544 </span>            :   }
<span class="lineNum">     545 </span>            :   // osvr checks that m_ctx or m_iface are not null
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :   osvr_ClientFreeInterface(m_ctx, m_iface);</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :   osvr_ClientShutdown(m_ctx);</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span>            : void
<span class="lineNum">     551 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::NotifyVSync()</span>
<span class="lineNum">     552 </span>            : {
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :   VRSystemManager::NotifyVSync();</span>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span>            :   // TODO - Check for device disconnection or other OSVR events
<span class="lineNum">     556 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span>            : void
<span class="lineNum">     559 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::Enumerate()</span>
<span class="lineNum">     560 </span>            : {
<span class="lineNum">     561 </span>            :   // make sure context, interface and display are initialized
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :   CheckOSVRStatus();</span>
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :   if (!Init()) {</span>
<span class="lineNum">     565 </span>            :     return;
<span class="lineNum">     566 </span>            :   }
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :   mHMDInfo = new VRDisplayOSVR(&amp;m_ctx, &amp;m_iface, &amp;m_display);</span>
<span class="lineNum">     569 </span>            : }
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span>            : bool
<span class="lineNum">     572 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::ShouldInhibitEnumeration()</span>
<span class="lineNum">     573 </span>            : {
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :   if (VRSystemManager::ShouldInhibitEnumeration()) {</span>
<span class="lineNum">     575 </span>            :     return true;
<span class="lineNum">     576 </span>            :   }
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :   if (mHMDInfo) {</span>
<span class="lineNum">     578 </span>            :     // When we find an a VR device, don't
<span class="lineNum">     579 </span>            :     // allow any further enumeration as it
<span class="lineNum">     580 </span>            :     // may get picked up redundantly by other
<span class="lineNum">     581 </span>            :     // API's.
<span class="lineNum">     582 </span>            :     return true;
<span class="lineNum">     583 </span>            :   }
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">     585 </span>            : }
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            : void
<span class="lineNum">     588 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::GetHMDs(nsTArray&lt;RefPtr&lt;VRDisplayHost&gt;&gt;&amp; aHMDResult)</span>
<span class="lineNum">     589 </span>            : {
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :   if (mHMDInfo) {</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :     aHMDResult.AppendElement(mHMDInfo);</span>
<span class="lineNum">     592 </span>            :   }
<span class="lineNum">     593 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span>            : bool
<span class="lineNum">     596 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::GetIsPresenting()</span>
<span class="lineNum">     597 </span>            : {
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :   if (mHMDInfo) {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :     VRDisplayInfo displayInfo(mHMDInfo-&gt;GetDisplayInfo());</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :     return displayInfo.GetPresentingGroups() != kVRGroupNone;</span>
<span class="lineNum">     601 </span>            :   }
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span>            :   return false;
<span class="lineNum">     604 </span>            : }
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span>            : void
<span class="lineNum">     607 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::HandleInput()</span>
<span class="lineNum">     608 </span>            : {
<span class="lineNum">     609 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span>            : void
<span class="lineNum">     612 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::VibrateHaptic(uint32_t aControllerIdx,</span>
<span class="lineNum">     613 </span>            :                                    uint32_t aHapticIndex,
<span class="lineNum">     614 </span>            :                                    double aIntensity,
<span class="lineNum">     615 </span>            :                                    double aDuration,
<span class="lineNum">     616 </span>            :                                    const VRManagerPromise&amp; aPromise)
<span class="lineNum">     617 </span>            : {
<span class="lineNum">     618 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     619 </span>            : 
<span class="lineNum">     620 </span>            : void
<span class="lineNum">     621 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::StopVibrateHaptic(uint32_t aControllerIdx)</span>
<span class="lineNum">     622 </span>            : {
<span class="lineNum">     623 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span>            : void
<span class="lineNum">     626 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::GetControllers(nsTArray&lt;RefPtr&lt;VRControllerHost&gt;&gt;&amp; aControllerResult)</span>
<span class="lineNum">     627 </span>            : {
<span class="lineNum">     628 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span>            : void
<span class="lineNum">     631 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::ScanForControllers()</span>
<span class="lineNum">     632 </span>            : {
<span class="lineNum">     633 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     634 </span>            : 
<span class="lineNum">     635 </span>            : void
<span class="lineNum">     636 </span><span class="lineNoCov">          0 : VRSystemManagerOSVR::RemoveControllers()</span>
<span class="lineNum">     637 </span>            : {
<span class="lineNum">     638 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13-14-ga5dd952</a></td></tr>
  </table>
  <br>

</body>
</html>
